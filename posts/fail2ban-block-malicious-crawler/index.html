<!doctype html>
<html lang="zh-TW">

<head>
    <title>使用Fail2ban阻擋惡意網絡爬蟲 // 碼農生活</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.54.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Doggor" />
    <meta name="description" content="Nginx的error.log裡面看到很多錯誤request, 不斷請求一些不存在的頁面，例如/wp-admin.php、/lucky.php、/aa.php等等。
若果你有架設維護過網頁伺服器的經驗，想必也遇過這種情況，即使未遇上，也只是時間的問題。" />
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="碼農生活">
    <link rel="apple-touch-icon" href="/images/icons/icon-152x152.png">
    <meta name="theme-color" content="#16191d" />
    
    
    <meta property="og:image" content="https://doggor.github.io//posts/fail2ban-block-malicious-crawler/thumbnail.jpg">
    
    
    <meta property="og:tags" content="fail2ban">
    
    <meta property="og:tags" content="nginx">
    
    <meta property="og:tags" content="php">
    
    <meta property="og:tags" content="malicious">
    
    <meta property="og:tags" content="crawler">
    
    <meta property="og:tags" content="firewall">
    
    <base href="https://doggor.github.io/" />
    <link rel="stylesheet" href="https://doggor.github.io/css/main.min.16abed0e30734b2607d642a17b5279ea.css" />
    <link rel="stylesheet" media="screen and (max-width: 939px)" href="https://doggor.github.io/css/mobile.min.be810d81064de9fff3dbf244d2814afb.css" />
    
    <script src="https://doggor.github.io/js/cookies-consent.min.3c6f7f73c9853ee1e5d637f02f1abaf6.js" defer></script>
    
    <script src="https://doggor.github.io/js/topbar-actions.min.9e50b64f91b4beeaa3d1458c8b469ab2.js" defer></script>
    
    
    
    <script src="https://doggor.github.io/js/service-worker-loader.min.js" defer></script>
    
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="preconnect" href="https://www.google-analytics.com">
    
    <script src="https://doggor.github.io/js/gtag.min.js" defer></script>
    
    
    <script src="https://doggor.github.io/js/sidebar.min.js" defer></script>
</head>

<body>
    <header class="app-header">
        <h3 class="app-header-wanna-say">&nbsp;</h3>
        <h1 class="app-header-my-face">_(:з」∠)_</h1>
        <a href="/" aria-label="Home"><h2>#碼農生活</h2></a>

        
        <div class="app-header-tag-group">
        
        
        <a class="tag-btn" href="/tags/binlog/" aria-label="tag:binlog">
            <span>binlog</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/canvas/" aria-label="tag:canvas">
            <span>canvas</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/centos/" aria-label="tag:centos">
            <span>centos</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/ci/" aria-label="tag:ci">
            <span>ci</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/crawler/" aria-label="tag:crawler">
            <span>crawler</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/debug/" aria-label="tag:debug">
            <span>debug</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/docker/" aria-label="tag:docker">
            <span>docker</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/fail2ban/" aria-label="tag:fail2ban">
            <span>fail2ban</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/firewall/" aria-label="tag:firewall">
            <span>firewall</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/ftp/" aria-label="tag:ftp">
            <span>ftp</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/git/" aria-label="tag:git">
            <span>git</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/gitlab/" aria-label="tag:gitlab">
            <span>gitlab</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/gzip/" aria-label="tag:gzip">
            <span>gzip</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/headless-chrome/" aria-label="tag:headless-chrome">
            <span>headless-chrome</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/html/" aria-label="tag:html">
            <span>html</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/indexing/" aria-label="tag:indexing">
            <span>indexing</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/influx/" aria-label="tag:influx">
            <span>influx</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/js/" aria-label="tag:js">
            <span>js</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/malicious/" aria-label="tag:malicious">
            <span>malicious</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/mysql/" aria-label="tag:mysql">
            <span>mysql</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/nginx/" aria-label="tag:nginx">
            <span>nginx</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/nodejs/" aria-label="tag:nodejs">
            <span>nodejs</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/ntp/" aria-label="tag:ntp">
            <span>ntp</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/php/" aria-label="tag:php">
            <span>php</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/puppeteer/" aria-label="tag:puppeteer">
            <span>puppeteer</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/react/" aria-label="tag:react">
            <span>react</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/sql/" aria-label="tag:sql">
            <span>sql</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/tfjs/" aria-label="tag:tfjs">
            <span>tfjs</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/vscode/" aria-label="tag:vscode">
            <span>vscode</span>
        </a>
        
        </div>
        

        <div class="app-header-links">
            <a class="tag-link" href="/categories" aria-label="Categories"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-folder">
  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
</svg></a>
            <a class="tag-link" href="/tags" aria-label="Tags"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg></a>
            
            <a target="_blank" href="https://github.com/doggor" rel="noopener" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
            
        </div>
    </header>

    <div class="app-topbar">
        <div class="app-topbar-menu-btn" aria-label="menu">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <a href="/" aria-label="Home">
            <h3>#碼農生活</h3>
        </a>
    </div>

    <main class="app-container">
        
  <article class="post">
    <header class="post-header">
      <div>
        <h1 class ="post-title">使用Fail2ban阻擋惡意網絡爬蟲</h1>
        


<div id="share-buttons">
<div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https:\/\/doggor.github.io\/\/posts\/fail2ban-block-malicious-crawler\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
<div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=https:\/\/doggor.github.io\/\/posts\/fail2ban-block-malicious-crawler\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
<div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https:\/\/doggor.github.io\/\/posts\/fail2ban-block-malicious-crawler\/&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>

<div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=https:\/\/doggor.github.io\/\/posts\/fail2ban-block-malicious-crawler\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>

      </div>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jun 4, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          5 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://doggor.github.io/tags/fail2ban/">fail2ban</a><a class="tag" href="https://doggor.github.io/tags/nginx/">nginx</a><a class="tag" href="https://doggor.github.io/tags/php/">php</a><a class="tag" href="https://doggor.github.io/tags/malicious/">malicious</a><a class="tag" href="https://doggor.github.io/tags/crawler/">crawler</a><a class="tag" href="https://doggor.github.io/tags/firewall/">firewall</a></div></div>
    </header>
    <div class="post-content">
      <p>Nginx的error.log裡面看到很多錯誤request, 不斷請求一些不存在的頁面，例如<code>/wp-admin.php</code>、<code>/lucky.php</code>、<code>/aa.php</code>等等。
若果你有架設維護過網頁伺服器的經驗，想必也遇過這種情況，即使未遇上，也只是時間的問題。</p>

<p>唉，那些惡意爬蟲好煩人</p>

<p>若果是簡單的web應用，直接在該應用的Nginx/Apache設定檔裡指定需要開放出來URL，其他沒有注明的都一律回傳404，比較好辦。但是啊，某些情況下，例如URL需要由web應用去自行處理(e.g. dynamic routes)、後台入口<code>/wp-admin.php</code>不能挷定IP等等，設定檔就無能為力了。以上情況，我們可以嘗試引入Fail2ban去解決。</p>

<p>以下是節錄自<a href="https://www.fail2ban.org/wiki/index.php/Main_Page">Fail2ban官方網頁的介紹</a>：</p>

<blockquote>
<p>Fail2ban scans log files (e.g. /var/log/apache/error_log) and bans IPs that show the malicious signs &ndash; too many password failures, seeking for exploits, etc. Generally Fail2Ban is then used to update firewall rules to reject the IP addresses for a specified amount of time, although any arbitrary other action (e.g. sending an email) could also be configured. Out of the box Fail2Ban comes with filters for various services (apache, courier, ssh, etc).</p>

<p>Fail2Ban is able to reduce the rate of incorrect authentications attempts however it cannot eliminate the risk that weak authentication presents. Configure services to use only two factor or public/private authentication mechanisms if you really want to protect services.</p>
</blockquote>

<p>Fail2ban透過監察目標程序的紀錄檔，例如Apache的<code>/var/log/apache/error_log</code>，或是今次Nginx範例的<code>/var/log/nginx/error.log</code>等，找出那些企圖暴力破解密碼、惡意登入等有問題的IP地址，然後更新防火墻規則(iptables、firewallID等)，在你指定的一段時間之內該IP的請求都會被擋下來。</p>

<p>Fail2ban預設支援的程序非常多，參數亦不少，以下將介紹CentOS7上安裝和設定Fail2Ban v0.9.5的方法，以阻擋PHP掃描。</p>

<h4 id="1-installation">1. Installation</h4>

<p>首先，確保已安裝<a href="https://fedoraproject.org/wiki/EPEL">EPEL</a>：</p>

<pre><code>#RHEL/CentOS 7
yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm

#建議也開啟optional, extras, 及HA repositories
subscription-manager repos --enable &quot;rhel-*-optional-rpms&quot; --enable &quot;rhel-*-extras-rpms&quot;  --enable &quot;rhel-ha-for-rhel-*-server-rpms&quot;
</code></pre>

<p>安裝Fail2Ban：</p>

<pre><code class="language-sh">yum install fail2ban
</code></pre>

<p>Fail2Ban的預設設定檔位於<code>/etc/fail2ban/jail.conf</code>，你可以透過創建/etc/fail2ban/*.local覆寫其設定。為方便解說，我們直接複製一份出來改寫：</p>

<pre><code class="language-sh">cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
</code></pre>

<p>接著編輯<code>/etc/fail2ban/jail.local</code>。</p>

<h4 id="2-ignoreip">2. IgnoreIP</h4>

<p>首先，如果你是使用固定IP連線到此機器，建議把你的IP加到ignoreip之上，確保不會被擋掉：</p>

<pre><code class="language-sh">vi /etc/fail2ban/jail.local
</code></pre>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">ignoreip = 127.0.0.1/8</code></pre></td></tr></table>
</div>
</div>

<p>ignoreip接受IP、IP range及完整domain，每個值以空白鍵或半形逗號分隔，不接受如<code>*.example.com</code>這類wildcard domain。</p>

<h4 id="3-action">3. Action</h4>

<p>透過設定<code>action</code>值，Fail2Ban可以向你發出IP封鎖報告電郵，也可以整合CloudFlare、blocklist.de等服務。預設提供有8種action，我們採用最基本的一種，不接收電郵，不整合第三方服務，僅僅把IP封鎖掉。這裡我們甚麼都不用改，若果想了解多些也可以看看下面關於action內容：
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">180
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">181
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">182
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">183
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">184
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">185
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">186
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">187
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">188
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">189
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">190
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">191
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">192
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">193
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">194
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">195
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">196
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">197
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">198
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">199
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">200
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">201
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">202
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">203
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">204
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">205
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">206
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">207
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">208
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">209
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">210
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">211
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">212
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">213
</span></span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf"># The simplest action to take: ban only
action_ = %(banaction)s[name=%(__name__)s, bantime=&#34;%(bantime)s&#34;, port=&#34;%(port)s&#34;, protocol=&#34;%(protocol)s&#34;, chain=&#34;%(chain)s&#34;]

# ban &amp; send an e-mail with whois report to the destemail.
action_mw = %(banaction)s[name=%(__name__)s, bantime=&#34;%(bantime)s&#34;, port=&#34;%(port)s&#34;, protocol=&#34;%(protocol)s&#34;, chain=&#34;%(chain)s&#34;]
            %(mta)s-whois[name=%(__name__)s, sender=&#34;%(sender)s&#34;, dest=&#34;%(destemail)s&#34;, protocol=&#34;%(protocol)s&#34;, chain=&#34;%(chain)s&#34;]

# ban &amp; send an e-mail with whois report and relevant log lines
# to the destemail.
action_mwl = %(banaction)s[name=%(__name__)s, bantime=&#34;%(bantime)s&#34;, port=&#34;%(port)s&#34;, protocol=&#34;%(protocol)s&#34;, chain=&#34;%(chain)s&#34;]
             %(mta)s-whois-lines[name=%(__name__)s, sender=&#34;%(sender)s&#34;, dest=&#34;%(destemail)s&#34;, logpath=%(logpath)s, chain=&#34;%(chain)s&#34;]

# See the IMPORTANT note in action.d/xarf-login-attack for when to use this action
#
# ban &amp; send a xarf e-mail to abuse contact of IP address and include relevant log lines
# to the destemail.
action_xarf = %(banaction)s[name=%(__name__)s, bantime=&#34;%(bantime)s&#34;, port=&#34;%(port)s&#34;, protocol=&#34;%(protocol)s&#34;, chain=&#34;%(chain)s&#34;]
             xarf-login-attack[service=%(__name__)s, sender=&#34;%(sender)s&#34;, logpath=%(logpath)s, port=&#34;%(port)s&#34;]

# ban IP on CloudFlare &amp; send an e-mail with whois report and relevant log lines
# to the destemail.
action_cf_mwl = cloudflare[cfuser=&#34;%(cfemail)s&#34;, cftoken=&#34;%(cfapikey)s&#34;]
                %(mta)s-whois-lines[name=%(__name__)s, sender=&#34;%(sender)s&#34;, dest=&#34;%(destemail)s&#34;, logpath=%(logpath)s, chain=&#34;%(chain)s&#34;]

# Report block via blocklist.de fail2ban reporting service API
#
# See the IMPORTANT note in action.d/blocklist_de.conf for when to
# use this action. Create a file jail.d/blocklist_de.local containing
# [Init]
# blocklist_de_apikey = {api key from registration]
#
action_blocklist_de  = blocklist_de[email=&#34;%(sender)s&#34;, service=%(filter)s, apikey=&#34;%(blocklist_de_apikey)s&#34;, agent=&#34;%(fail2ban_agent)s&#34;]

# Report ban via badips.com, and use as blacklist
#
# See BadIPsAction docstring in config/action.d/badips.py for
# documentation for this action.
#
# NOTE: This action relies on banaction being present on start and therefore
# should be last action defined for a jail.
#
action_badips = badips.py[category=&#34;%(__name__)s&#34;, banaction=&#34;%(banaction)s&#34;, agent=&#34;%(fail2ban_agent)s&#34;]
#
# Report ban via badips.com (uses action.d/badips.conf for reporting only)
#
action_badips_report = badips[category=&#34;%(__name__)s&#34;, agent=&#34;%(fail2ban_agent)s&#34;]

# Choose default action.  To change, just override value of &#39;action&#39; with the
# interpolation to the chosen action shortcut (e.g.  action_mw, action_mwl, etc) in jail.local
# globally (section [DEFAULT]) or per specific section
<span style="display:block;width:100%;background-color:#3c3d38">action = %(action_)s</span></code></pre></td></tr></table>
</div>
</div></p>

<blockquote>
<p>遇上惡意爬蟲少則數百多則數千數萬，決定開啟電郵通知前請先三思。</p>
</blockquote>

<h4 id="4-nginx-botsearch">4. Nginx botsearch</h4>

<p>你會看到預設支援各式各樣服務，而這些服務一開始是未啟用的。讓我們找到nginx-botsearch設定並加入<code>enabled = true</code>以啟用它：
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">343
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">344
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">345
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">346
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">347
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">348
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">[nginx-botsearch]
<span style="display:block;width:100%;background-color:#3c3d38">enabled     = true
</span>port        = http,https
logpath     = %(nginx_error_log)s #預設是/var/log/nginx/error.log
logencoding = utf-8
maxretry    = 2</code></pre></td></tr></table>
</div>
</div></p>

<p>nginx-botsearch服務會持續掃描<code>logpath</code>檔案，如果發現有IP發出的有問題請求紀錄超過<code>maxretry</code>，它就會被封鎖。</p>

<h4 id="5-filter">5. Filter</h4>

<p>Fail4ban透過預先於<code>/etc/fail2ban/filter.d/</code>下定義的規則來尋找有問題的請求紀錄，並從中抽取來源IP。nginx-botsearch的規則定義在同名的nginx-botsearch.conf內。由於這裡未有我們需要的規則，所以要在<code>failregex</code>加入新的正則表達式，用以找出所有&rdquo;Primary script unknown&rdquo;錯誤的紀錄：</p>

<pre><code>vi /etc/fail2ban/filter.d/nginx-botsearch.conf
</code></pre>

<p>加入第13行的規則：</p>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">12
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">13
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7c7c79">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf"># Fail2Ban filter to match web requests for selected URLs that don&#39;t exist
#

[INCLUDES]

# Load regexes for filtering
before = botsearch-common.conf

[Definition]

failregex = ^&lt;HOST&gt; \- \S+ \[\] \&#34;(GET|POST|HEAD) \/&lt;block&gt; \S+\&#34; 404 .+$
            ^ \[error\] \d+#\d+: \*\d+ (\S+ )?\&#34;\S+\&#34; (failed|is not found) \(2\: No such file or directory\), client\: &lt;HOST&gt;\, server\: \S*\, request: \&#34;(GET|POST|HEAD) \/&lt;block&gt; \S+\&#34;\, .*?$
<span style="display:block;width:100%;background-color:#3c3d38">            ^ \[error\] \d+#\d+: \*\d+ FastCGI sent in stderr: \&#34;Primary script unknown\&#34; while reading response header from upstream, client\: &lt;HOST&gt;\, server\: \S*\, request: \&#34;(GET|POST|HEAD) \/&lt;block&gt; \S+\&#34;\, .*?$
</span>
ignoreregex =


# DEV Notes:
# Based on apache-botsearch filter
#
# Author: Frantisek Sumsal</code></pre></td></tr></table>
</div>
</div>

<h4 id="6-startup">6. Startup</h4>

<p>以上我們的設定完成後，利用<code>fail2ban-client start</code>指令來啟動服務：</p>

<pre><code class="language-sh">fail2ban-client start

# 2019-06-06 12:51:48,762 fail2ban.server         [226332]: INFO    Starting Fail2ban v0.9.7
# 2019-06-06 12:51:48,762 fail2ban.server         [226332]: INFO    Starting in daemon mode
</code></pre>

<p>透過<code>fail2ban-client status</code>可以查看當前有甚麼服務正在運行：</p>

<pre><code class="language-sh">fail2ban-client status

# Status
# |- Number of jail:      1
# `- Jail list:   nginx-botsearch
</code></pre>

<p>指明服務名稱則可看見該服務現時IP封鎖相關訊息：</p>

<pre><code class="language-sh">fail2ban-client status nginx-botsearch

# Status for the jail: nginx-botsearch
# |- Filter
# |  |- Currently failed: 2
# |  |- Total failed:     72
# |  `- File list:        /var/log/nginx/error.log
# `- Actions
#    |- Currently banned: 16
#    |- Total banned:     16
#    `- Banned IP list:   119.29.96.35 159.138.0.69 114.67.224.81 52.80.101.24 118.24.122.13 154.83.13.182 140.143.81.182 140.143.0.54 116.196.67.120 148.70.68.20 129.204.75.114 190.85.91.54 59.34.4.176 45.125.12.228 121.133.252.253 104.40.242.46
</code></pre>

<p>往後若要對設定檔作出修改，可利用<code>fail2ban-client reload</code>重新加載：</p>

<pre><code class="language-sh">fail2ban-client reload
</code></pre>
    </div>
  </article>
  <section class="disqus-area"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "doggor-coding-notebook" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section>

    </main>
</body>

</html>
