<!doctype html><html lang=zh-TW><head><title>OAuth2 æ•´åˆçš„å®‰å…¨æ ¸å¿ƒï¼šstate èˆ‡ nonce åƒæ•¸çš„æ­£ç¢ºä½¿ç”¨èˆ‡é©—è­‰ // ç¨‹å¼é­”æ³•é™£</title><meta charset=utf-8><meta name=generator content="Hugo 0.155.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Doggor"><meta name=description content="åœ¨ç¾ä»£ç¶²é èˆ‡è¡Œå‹•æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæ•´åˆç¬¬ä¸‰æ–¹ç™»å…¥ï¼ˆå¦‚ Googleã€Facebookã€Sign In with Appleï¼Œç°¡ç¨± SIWAï¼‰å·²æ˜¯æ¨™æº–åŠŸèƒ½ã€‚é€™äº›åŠŸèƒ½åŸºæ–¼ OAuth 2.0 å”è­°ï¼Œä¸¦å¸¸æ­é… OpenID Connect (OIDC) æ“´å±•ä¾†å–å¾—ä½¿ç”¨è€…èº«ä»½è³‡è¨Šã€‚ç„¶è€Œï¼Œé–‹ç™¼è€…åœ¨å¯¦ä½œæ™‚æœ€å¸¸å¿½ç•¥çš„è³‡å®‰é—œéµï¼Œæ­£æ˜¯ state èˆ‡ nonce å…©å€‹åƒæ•¸çš„æ­£ç¢ºç”Ÿæˆã€å‚³éèˆ‡é©—è­‰ã€‚"><link rel=manifest href=/manifest.json><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="ç¨‹å¼é­”æ³•é™£"><link rel=apple-touch-icon href=/images/icons/icon-152x152.png><meta name=theme-color content="#16191d"><meta property="og:image" content="https://doggor.github.io//posts/2026/auth2-ocid-state-nonce-security/thumbnail.jpg"><meta property="og:tags" content="oauth2"><meta property="og:tags" content="openid-connect"><meta property="og:tags" content="security"><meta property="og:tags" content="CSRF"><meta property="og:tags" content="replay-attack"><meta property="og:tags" content="state"><meta property="og:tags" content="nonce"><base href=https://doggor.github.io/><style>body{background-color:#16191d;color:#16191d}a{color:#16191d}input,img{display:none}</style><link rel=preload as=style href=https://doggor.github.io/css/main.min.0ebf9bc81f3970b60cc52ad14ae0227d.css onload='this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://doggor.github.io/css/main.min.0ebf9bc81f3970b60cc52ad14ae0227d.css></noscript><link rel=preload as=style media="screen and (max-width: 939px)" href=https://doggor.github.io/css/mobile.min.59580f7f6c75a063777b2241648dadac.css onload='this.rel="stylesheet"'><noscript><link rel=stylesheet media="screen and (max-width: 939px)" href=https://doggor.github.io/css/mobile.min.59580f7f6c75a063777b2241648dadac.css></noscript><script src=https://doggor.github.io/js/bundle.min.c765417f5f9a85fd757fd8638bf5aa1a.js async></script></head><body class=darkmode--activated><div class=app-centralizer><header class=app-header><div class=mobile-back-btn></div><h3 class=app-header-wanna-say>&nbsp;</h3><h1 class=app-header-my-face>_(:Ğ·ã€âˆ )_</h1><a class=app-header-title href=/ aria-label=Home><h2>#ç¨‹å¼é­”æ³•é™£</h2></a><div class=app-header-tag-group><a class=tag-btn href=/tags/bert/ aria-label=tag:bert><span>bert</span>
</a><a class=tag-btn href=/tags/binlog/ aria-label=tag:binlog><span>binlog</span>
</a><a class=tag-btn href=/tags/canvas/ aria-label=tag:canvas><span>canvas</span>
</a><a class=tag-btn href=/tags/centos/ aria-label=tag:centos><span>centos</span>
</a><a class=tag-btn href=/tags/cert/ aria-label=tag:cert><span>cert</span>
</a><a class=tag-btn href=/tags/ci/ aria-label=tag:ci><span>ci</span>
</a><a class=tag-btn href=/tags/crawler/ aria-label=tag:crawler><span>crawler</span>
</a><a class=tag-btn href=/tags/csrf/ aria-label=tag:csrf><span>csrf</span>
</a><a class=tag-btn href=/tags/data/ aria-label=tag:data><span>data</span>
</a><a class=tag-btn href=/tags/debug/ aria-label=tag:debug><span>debug</span>
</a><a class=tag-btn href=/tags/design-pattern/ aria-label=tag:design-pattern><span>design-pattern</span>
</a><a class=tag-btn href=/tags/docker/ aria-label=tag:docker><span>docker</span>
</a><a class=tag-btn href=/tags/exam/ aria-label=tag:exam><span>exam</span>
</a><a class=tag-btn href=/tags/fail2ban/ aria-label=tag:fail2ban><span>fail2ban</span>
</a><a class=tag-btn href=/tags/firewall/ aria-label=tag:firewall><span>firewall</span>
</a><a class=tag-btn href=/tags/ftp/ aria-label=tag:ftp><span>ftp</span>
</a><a class=tag-btn href=/tags/git/ aria-label=tag:git><span>git</span>
</a><a class=tag-btn href=/tags/gitlab/ aria-label=tag:gitlab><span>gitlab</span>
</a><a class=tag-btn href=/tags/google/ aria-label=tag:google><span>google</span>
</a><a class=tag-btn href=/tags/gzip/ aria-label=tag:gzip><span>gzip</span>
</a><a class=tag-btn href=/tags/headless-chrome/ aria-label=tag:headless-chrome><span>headless-chrome</span>
</a><a class=tag-btn href=/tags/html/ aria-label=tag:html><span>html</span>
</a><a class=tag-btn href=/tags/indexing/ aria-label=tag:indexing><span>indexing</span>
</a><a class=tag-btn href=/tags/influx/ aria-label=tag:influx><span>influx</span>
</a><a class=tag-btn href=/tags/js/ aria-label=tag:js><span>js</span>
</a><a class=tag-btn href=/tags/learning-notes/ aria-label=tag:learning-notes><span>learning-notes</span>
</a><a class=tag-btn href=/tags/malicious/ aria-label=tag:malicious><span>malicious</span>
</a><a class=tag-btn href=/tags/marketing/ aria-label=tag:marketing><span>marketing</span>
</a><a class=tag-btn href=/tags/mysql/ aria-label=tag:mysql><span>mysql</span>
</a><a class=tag-btn href=/tags/nginx/ aria-label=tag:nginx><span>nginx</span>
</a><a class=tag-btn href=/tags/nodejs/ aria-label=tag:nodejs><span>nodejs</span>
</a><a class=tag-btn href=/tags/nonce/ aria-label=tag:nonce><span>nonce</span>
</a><a class=tag-btn href=/tags/ntp/ aria-label=tag:ntp><span>ntp</span>
</a><a class=tag-btn href=/tags/oauth2/ aria-label=tag:oauth2><span>oauth2</span>
</a><a class=tag-btn href=/tags/openid-connect/ aria-label=tag:openid-connect><span>openid-connect</span>
</a><a class=tag-btn href=/tags/php/ aria-label=tag:php><span>php</span>
</a><a class=tag-btn href=/tags/puppeteer/ aria-label=tag:puppeteer><span>puppeteer</span>
</a><a class=tag-btn href=/tags/pytorch/ aria-label=tag:pytorch><span>pytorch</span>
</a><a class=tag-btn href=/tags/react/ aria-label=tag:react><span>react</span>
</a><a class=tag-btn href=/tags/repair/ aria-label=tag:repair><span>repair</span>
</a><a class=tag-btn href=/tags/replay-attack/ aria-label=tag:replay-attack><span>replay-attack</span>
</a><a class=tag-btn href=/tags/rust/ aria-label=tag:rust><span>rust</span>
</a><a class=tag-btn href=/tags/search-ads/ aria-label=tag:search-ads><span>search-ads</span>
</a><a class=tag-btn href=/tags/security/ aria-label=tag:security><span>security</span>
</a><a class=tag-btn href=/tags/seo/ aria-label=tag:seo><span>seo</span>
</a><a class=tag-btn href=/tags/state/ aria-label=tag:state><span>state</span>
</a><a class=tag-btn href=/tags/tensorflow/ aria-label=tag:tensorflow><span>tensorflow</span>
</a><a class=tag-btn href=/tags/tool/ aria-label=tag:tool><span>tool</span>
</a><a class=tag-btn href=/tags/typo-detection/ aria-label=tag:typo-detection><span>typo-detection</span>
</a><a class=tag-btn href=/tags/vscode/ aria-label=tag:vscode><span>vscode</span></a></div><div class=app-header-links><a class=tag-link href=/categories aria-label=Categories><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-folder"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg></a>
<a class=tag-link href=/tags aria-label=Tags><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg></a>
<a target=_blank href=https://github.com/doggor rel=noopener aria-label=Github><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a>
<a target=_blank href=https://www.linkedin.com/in/andy-ching-hk rel=noopener aria-label=Github><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div><label class=planet-switch><input type=checkbox name=darkmode checked aria-label="toggle darkmode" id=darkmode-switch-checkbox><div class="planet moon"><div class=rays><div class=ray></div><div class=ray></div><div class=ray></div></div><div class=core></div><div class=hole></div><div class=hole></div></div></label></header><div class=app-topbar><div class=app-topbar-menu-btn aria-label=menu></div><a href=/ aria-label=Home><h3>#ç¨‹å¼é­”æ³•é™£</h3></a></div><main class=app-container><article class=post><header class=post-header><div><picture><source srcset="/posts/2026/auth2-ocid-state-nonce-security/thumbnail_hu_8868e4716d2b25b.webp, /posts/2026/auth2-ocid-state-nonce-security/thumbnail_hu_f4aafbf71d63cc96.webp 2x" type=image/webp><source srcset="/posts/2026/auth2-ocid-state-nonce-security/thumbnail_hu_32ce5f9d5ec3444.jpg, /posts/2026/auth2-ocid-state-nonce-security/thumbnail_hu_7ff30aa991d0aad.jpg 2x" type=image/jpg><img class=post-cover src=/posts/2026/auth2-ocid-state-nonce-security/thumbnail_hu_32ce5f9d5ec3444.jpg alt></picture></div><div><h1 class=post-title>OAuth2 æ•´åˆçš„å®‰å…¨æ ¸å¿ƒï¼šstate èˆ‡ nonce åƒæ•¸çš„æ­£ç¢ºä½¿ç”¨èˆ‡é©—è­‰</h1></div><div class=post-meta><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Feb 16, 2026</div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
6 min read</div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<a class=tag href=https://doggor.github.io/tags/oauth2/>oauth2</a><a class=tag href=https://doggor.github.io/tags/openid-connect/>openid-connect</a><a class=tag href=https://doggor.github.io/tags/security/>security</a><a class=tag href=https://doggor.github.io/tags/csrf/>csrf</a><a class=tag href=https://doggor.github.io/tags/replay-attack/>replay-attack</a><a class=tag href=https://doggor.github.io/tags/state/>state</a><a class=tag href=https://doggor.github.io/tags/nonce/>nonce</a></div></div></header><div class=post-content><p>åœ¨ç¾ä»£ç¶²é èˆ‡è¡Œå‹•æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæ•´åˆç¬¬ä¸‰æ–¹ç™»å…¥ï¼ˆå¦‚ Googleã€Facebookã€Sign In with Appleï¼Œç°¡ç¨± SIWAï¼‰å·²æ˜¯æ¨™æº–åŠŸèƒ½ã€‚é€™äº›åŠŸèƒ½åŸºæ–¼ <strong>OAuth 2.0</strong> å”è­°ï¼Œä¸¦å¸¸æ­é… <strong>OpenID Connect (OIDC)</strong> æ“´å±•ä¾†å–å¾—ä½¿ç”¨è€…èº«ä»½è³‡è¨Šã€‚ç„¶è€Œï¼Œé–‹ç™¼è€…åœ¨å¯¦ä½œæ™‚æœ€å¸¸å¿½ç•¥çš„è³‡å®‰é—œéµï¼Œæ­£æ˜¯ <strong>state</strong> èˆ‡ <strong>nonce</strong> å…©å€‹åƒæ•¸çš„æ­£ç¢ºç”Ÿæˆã€å‚³éèˆ‡é©—è­‰ã€‚</p><p>æœ¬æ–‡å°‡è©³ç´°èªªæ˜é€™å…©å€‹åƒæ•¸çš„ä½œç”¨ï¼Œä»¥åŠåœ¨ç¼ºä¹é©—è­‰æ™‚æœƒå¼•ç™¼çš„åš´é‡å®‰å…¨å•é¡Œã€‚ç„¡è«–ä½ æ˜¯å‰ç«¯å·¥ç¨‹å¸«ã€å¾Œç«¯é–‹ç™¼è€…ï¼Œæˆ–æ­£åœ¨æ•´åˆ Google / Facebook / SIWA çš„é–‹ç™¼åœ˜éšŠï¼Œæœ¬æ–‡éƒ½èƒ½å¹«åŠ©ä½ å¾¹åº•æŒæ¡é€™äº›æ©Ÿåˆ¶ï¼Œé¿å…å¸¸è¦‹è³‡å®‰æ¼æ´ã€‚</p><h2 id=1-state-åƒæ•¸çš„ä½œç”¨èˆ‡é‹ä½œæ©Ÿåˆ¶>1. state åƒæ•¸çš„ä½œç”¨èˆ‡é‹ä½œæ©Ÿåˆ¶</h2><p><strong>state</strong> æ˜¯ OAuth 2.0 æ¨™æº–ï¼ˆRFC 6749ï¼‰ä¸­ç”¨ä¾†<strong>é˜²æ­¢è·¨ç«™è«‹æ±‚å½é€  (Cross-Site Request Forgery, CSRF)</strong> çš„æ ¸å¿ƒåƒæ•¸ã€‚å®ƒæ˜¯ä¸€å€‹ç”±å®¢æˆ¶ç«¯ï¼ˆä½ çš„æ‡‰ç”¨ç¨‹å¼ï¼‰ç”Ÿæˆçš„<strong>éš¨æ©Ÿã€ä¸é€æ˜ã€ä¸å¯çŒœæ¸¬</strong>çš„å­—ä¸²ï¼Œç”¨ä¾†å°‡ã€Œæˆæ¬Šè«‹æ±‚ã€èˆ‡ã€Œæˆæ¬Šå›æ‡‰ã€åš´æ ¼ç¶å®šã€‚</p><h3 id=state-çš„ä¸»è¦åŠŸèƒ½>state çš„ä¸»è¦åŠŸèƒ½</h3><ul><li>é˜²æ­¢ CSRF æ”»æ“Š</li><li>æ¢å¾©æ‡‰ç”¨ç¨‹å¼åŸå§‹ç‹€æ…‹ï¼ˆä¾‹å¦‚ç™»å…¥å¾Œè¦è·³è½‰çš„é é¢ï¼‰</li><li>ç¢ºä¿å›æ‡‰ç¢ºå¯¦ä¾†è‡ªä½ è‡ªå·±ç™¼èµ·çš„è«‹æ±‚</li></ul><h3 id=æ¨™æº–é‹ä½œæµç¨‹ä»¥-authorization-code-flow-ç‚ºä¾‹>æ¨™æº–é‹ä½œæµç¨‹ï¼ˆä»¥ Authorization Code Flow ç‚ºä¾‹ï¼‰</h3><pre class=mermaid>
  sequenceDiagram
    participant ç”¨æˆ¶
    participant å®¢æˆ¶ç«¯æ‡‰ç”¨
    participant æˆæ¬Šä¼ºæœå™¨ as æˆæ¬Šä¼ºæœå™¨&lt;br&gt;(Google / Facebook / Apple)
    
    ç”¨æˆ¶-&gt;&gt;å®¢æˆ¶ç«¯æ‡‰ç”¨: é»æ“Šã€Œä½¿ç”¨ Google ç™»å…¥ã€
    å®¢æˆ¶ç«¯æ‡‰ç”¨-&gt;&gt;å®¢æˆ¶ç«¯æ‡‰ç”¨: ç”Ÿæˆéš¨æ©Ÿ state ä¸¦å®‰å…¨å„²å­˜&lt;br&gt;(sessionStorage / server session)
    å®¢æˆ¶ç«¯æ‡‰ç”¨-&gt;&gt;æˆæ¬Šä¼ºæœå™¨: GET /authorize?client_id=...&amp;redirect_uri=...&amp;state=abc123...
    æˆæ¬Šä¼ºæœå™¨-&gt;&gt;ç”¨æˆ¶: é¡¯ç¤ºç™»å…¥èˆ‡åŒæ„ç•«é¢
    ç”¨æˆ¶-&gt;&gt;æˆæ¬Šä¼ºæœå™¨: è¼¸å…¥æ†‘è­‰ä¸¦åŒæ„
    æˆæ¬Šä¼ºæœå™¨-&gt;&gt;å®¢æˆ¶ç«¯æ‡‰ç”¨: é‡å°å‘ redirect_uri?code=xyz&amp;state=abc123
    å®¢æˆ¶ç«¯æ‡‰ç”¨-&gt;&gt;å®¢æˆ¶ç«¯æ‡‰ç”¨: é©—è­‰è¿”å›çš„ state æ˜¯å¦èˆ‡å„²å­˜å€¼å®Œå…¨ä¸€è‡´
    alt é©—è­‰æˆåŠŸ
        å®¢æˆ¶ç«¯æ‡‰ç”¨-&gt;&gt;æˆæ¬Šä¼ºæœå™¨: POST /token äº¤æ› code å–å¾— token
    else é©—è­‰å¤±æ•—
        å®¢æˆ¶ç«¯æ‡‰ç”¨--&gt;&gt;ç”¨æˆ¶: æ‹’çµ•è«‹æ±‚ä¸¦è¨˜éŒ„æ½›åœ¨æ”»æ“Š
    end
</pre><h3 id=è‹¥ç¼ºä¹-state-é©—è­‰æœƒç™¼ç”Ÿä»€éº¼å•é¡Œ>è‹¥ç¼ºä¹ state é©—è­‰ï¼Œæœƒç™¼ç”Ÿä»€éº¼å•é¡Œï¼Ÿ</h3><p>æ²’æœ‰ state é©—è­‰æ™‚ï¼Œæ”»æ“Šè€…å¯è¼•æ˜“ç™¼å‹• login CSRF æˆ– authorization code injection æ”»æ“Šï¼š</p><pre class=mermaid>
  sequenceDiagram
    participant æ”»æ“Šè€…
    participant ç”¨æˆ¶
    participant å®¢æˆ¶ç«¯æ‡‰ç”¨
    
    æ”»æ“Šè€…-&gt;&gt;ç”¨æˆ¶: èª˜å°é»æ“Šæƒ¡æ„é€£çµï¼ˆæˆ–è‡ªå‹•è¼‰å…¥ä½ çš„ /authorize URLï¼‰
    ç”¨æˆ¶-&gt;&gt;å®¢æˆ¶ç«¯æ‡‰ç”¨: è™•ç†æœªç¶“é©—è­‰çš„ callbackï¼ˆæ”œå¸¶æ”»æ“Šè€…å–å¾—çš„ codeï¼‰
    å®¢æˆ¶ç«¯æ‡‰ç”¨-&gt;&gt;å®¢æˆ¶ç«¯æ‡‰ç”¨: ç›´æ¥äº¤æ› code ä¸¦å»ºç«‹ session
    Note over å®¢æˆ¶ç«¯æ‡‰ç”¨: å—å®³è€…è¢«ç™»å…¥ç‚ºã€Œæ”»æ“Šè€…çš„ Google/Facebook å¸³è™Ÿã€
</pre><h3 id=å…·é«”å±å®³>å…·é«”å±å®³ï¼š</h3><ul><li>å—å®³è€…å¸³è™Ÿè¢«ç¶å®šæ”»æ“Šè€…çš„ç¬¬ä¸‰æ–¹èº«ä»½</li><li>æ”»æ“Šè€…å¯å­˜å–å—å®³è€…åœ¨ä½ æ‡‰ç”¨ä¸­çš„æ•æ„Ÿè³‡æ–™</li><li>å¯èƒ½å°è‡´å¸³è™Ÿæ¥ç®¡ã€æœªç¶“æˆæ¬Šè½‰å¸³ã€è³‡æ–™å¤–æ´©ç­‰åš´é‡å¾Œæœ</li></ul><p>Auth0ã€Google å®˜æ–¹æ–‡ä»¶èˆ‡ OWASP å‡å¼·çƒˆå»ºè­°å¿…é ˆé©—è­‰ stateã€‚</p><h2 id=2-nonce-åƒæ•¸çš„ä½œç”¨èˆ‡é‹ä½œæ©Ÿåˆ¶>2. nonce åƒæ•¸çš„ä½œç”¨èˆ‡é‹ä½œæ©Ÿåˆ¶</h2><p><strong>nonce</strong>ï¼ˆnumber used onceï¼Œä¸€æ¬¡æ€§æ•¸å€¼ï¼‰ä¸»è¦ç”¨æ–¼ OpenID Connectï¼Œç›®çš„æ˜¯é˜²æ­¢ ID Token çš„é‡æ”¾æ”»æ“Š (Replay Attack)ã€‚</p><p>ID Token æ˜¯ç”±æˆæ¬Šä¼ºæœå™¨ç°½ç« çš„ JWTï¼ŒåŒ…å« subï¼ˆä½¿ç”¨è€…å”¯ä¸€è­˜åˆ¥ï¼‰ã€expã€iat ç­‰æ¬„ä½ã€‚è‹¥æ²’æœ‰ nonceï¼Œæ”»æ“Šè€…å³ä½¿ç„¡æ³•å½é€ ç°½ç« ï¼Œä»å¯é‡ç”¨å…ˆå‰æˆªå–çš„æœ‰æ•ˆ ID Tokenã€‚</p><h3 id=nonce-çš„é‹ä½œæµç¨‹>nonce çš„é‹ä½œæµç¨‹</h3><pre class=mermaid>
  sequenceDiagram
    participant å®¢æˆ¶ç«¯
    participant æˆæ¬Šä¼ºæœå™¨
    participant å¾Œç«¯ä¼ºæœå™¨
    
    å®¢æˆ¶ç«¯-&gt;&gt;å®¢æˆ¶ç«¯: ç”Ÿæˆ nonce ä¸¦å„²å­˜ï¼ˆèˆ‡ state ä¸€èµ·ï¼‰
    å®¢æˆ¶ç«¯-&gt;&gt;æˆæ¬Šä¼ºæœå™¨: /authorize?nonce=xyz123...
    æˆæ¬Šä¼ºæœå™¨-&gt;&gt;å®¢æˆ¶ç«¯: é‡å°å‘ + code
    å®¢æˆ¶ç«¯-&gt;&gt;æˆæ¬Šä¼ºæœå™¨: äº¤æ› code å–å¾— ID Token
    æˆæ¬Šä¼ºæœå™¨-&gt;&gt;å®¢æˆ¶ç«¯: è¿”å› ID Tokenï¼ˆJWT ä¸­åŒ…å« &#34;nonce&#34;: &#34;xyz123&#34;ï¼‰
    å®¢æˆ¶ç«¯-&gt;&gt;å¾Œç«¯ä¼ºæœå™¨: å°‡ ID Token å‚³çµ¦å¾Œç«¯é©—è­‰
    å¾Œç«¯ä¼ºæœå™¨-&gt;&gt;å¾Œç«¯ä¼ºæœå™¨: é©—è­‰ç°½ç«  + æª¢æŸ¥ nonce æ˜¯å¦èˆ‡æœ¬æ¬¡ session å„²å­˜å€¼ä¸€è‡´
</pre><h3 id=è‹¥ç¼ºä¹-nonce-é©—è­‰æœƒç™¼ç”Ÿä»€éº¼å•é¡Œ>è‹¥ç¼ºä¹ nonce é©—è­‰ï¼Œæœƒç™¼ç”Ÿä»€éº¼å•é¡Œï¼Ÿ</h3><p>æ”»æ“Šè€…å¯å¾ç€è¦½å™¨æ­·å²ã€ç¶²è·¯è¨˜éŒ„ã€æˆ–å…ˆå‰ session ä¸­å–å¾—æœ‰æ•ˆ ID Tokenï¼Œç„¶å¾Œç›´æ¥é‡æ”¾çµ¦ä½ çš„æ‡‰ç”¨ï¼š</p><ul><li>ä½ çš„æ‡‰ç”¨åªé©—è­‰ JWT ç°½ç« èˆ‡åˆ°æœŸæ™‚é–“ â†’ æ¥å—èˆŠ token</li><li>æ”»æ“Šè€…æˆåŠŸä»¥å—å®³è€…èº«ä»½ç™»å…¥</li><li>å°¤å…¶åœ¨ Implicit Flow æˆ–æ··åˆæµä¸­é¢¨éšªæ›´é«˜</li></ul><p>Apple å®˜æ–¹æ–‡ä»¶ç‰¹åˆ¥å¼·èª¿ï¼šnonce å¿…é ˆåœ¨ä¼ºæœå™¨ç«¯é©—è­‰ï¼Œä»¥é˜²æ­¢é‡æ”¾ã€‚</p><h2 id=3-åœ¨-googlefacebook-èˆ‡-siwa-ä¸­çš„å¯¦éš›æ‡‰ç”¨>3. åœ¨ Googleã€Facebook èˆ‡ SIWA ä¸­çš„å¯¦éš›æ‡‰ç”¨</h2><table><thead><tr><th>æä¾›è€…</th><th>state ä½¿ç”¨æƒ…å¢ƒ</th><th>nonce ä½¿ç”¨æƒ…å¢ƒ</th><th>å®˜æ–¹å»ºè­°</th></tr></thead><tbody><tr><td>Google</td><td>OAuth2 / OIDC å‡å»ºè­°ä½¿ç”¨ï¼Œç”¨æ–¼é˜²æ­¢ CSRF ä¸¦æ¢å¾©åŸå§‹ç‹€æ…‹</td><td>OIDC å¿…é ˆåœ¨é©—è­‰ ID Token æ™‚æª¢æŸ¥ nonceï¼ˆé˜²é‡æ”¾ï¼‰</td><td>å¿…é ˆé©—è­‰ stateï¼›å° OIDC å¿…é ˆé©—è­‰ nonce</td></tr><tr><td>Facebook</td><td>OAuth2 ç™»å…¥å¿…é ˆä½¿ç”¨ stateï¼ˆé˜² CSRFã€ç¶å®šè«‹æ±‚ï¼‰</td><td>Facebook ä¸æä¾›å®Œæ•´ OIDCï¼Œç„¡æ¨™æº– nonceï¼ˆè‹¥è‡ªè¡Œå¯¦ä½œéœ€é¡å¤–é©—è­‰ï¼‰</td><td>å¿…é ˆä½¿ç”¨ stateï¼›nonce ç„¡æ¨™æº–æ”¯æ´ï¼Œè¦–æƒ…æ³è‡ªè¡Œè¨­è¨ˆé©—è­‰</td></tr><tr><td>SIWA (Sign In with Apple)</td><td>å®¢æˆ¶ç«¯éœ€æª¢æŸ¥å›å‚³çš„ stateï¼ˆé˜² CSRFã€æ¢å¾©è·³è½‰ï¼‰</td><td>ä¼ºæœå™¨ç«¯éœ€é©—è­‰ ID Token ä¸­çš„ nonceï¼ˆé˜²é‡æ”¾ï¼‰</td><td>å…©è€…çš†å¿…é ˆï¼šå®¢æˆ¶ç«¯é©—è­‰ stateï¼Œå¾Œç«¯é©—è­‰ JWT çš„ nonce</td></tr></tbody></table><p><strong>SIWA ç‰¹åˆ¥æ³¨æ„</strong>ï¼šApple æœƒåœ¨å›æ‡‰ä¸­åŒæ™‚è¿”å› state èˆ‡åŒ…å« nonce çš„ identityTokenã€‚é–‹ç™¼è€…éœ€åœ¨å®¢æˆ¶ç«¯æª¢æŸ¥ stateï¼Œåœ¨å¾Œç«¯ä½¿ç”¨ jsonwebtoken æˆ– Apple å…¬é‘°é©—è­‰ nonceã€‚</p><h2 id=4-typescript-å½ç¢¼ç¯„ä¾‹å‰ç«¯-spa>4. TypeScript å½ç¢¼ç¯„ä¾‹ï¼ˆå‰ç«¯ SPAï¼‰</h2><p>ä»¥ä¸‹ç¯„ä¾‹é©ç”¨æ–¼ React / Next.js / Vue ç­‰å–®é æ‡‰ç”¨ï¼Œä½¿ç”¨ Web Crypto API ç”Ÿæˆé«˜ç†µéš¨æ©Ÿå€¼ã€‚</p><h3 id=ç”Ÿæˆèˆ‡å•Ÿå‹•ç™»å…¥>ç”Ÿæˆèˆ‡å•Ÿå‹•ç™»å…¥</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// utils/oauth.ts
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>generateSecureRandom</span>(<span style=color:#a6e22e>length</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>array</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>(<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>getRandomValues</span>(<span style=color:#a6e22e>array</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Array.<span style=color:#66d9ef>from</span>(<span style=color:#a6e22e>array</span>, (<span style=color:#a6e22e>b</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>16</span>).<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;0&#39;</span>)).<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>startOAuthLogin</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>provider</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;google&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;facebook&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;apple&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>redirectAfterLogin?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>generateSecureRandom</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nonce</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;facebook&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>generateSecureRandom</span>() <span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å„²å­˜ï¼ˆSPA æ¨è–¦ sessionStorageï¼›ç”Ÿç”¢ç’°å¢ƒå»ºè­°å¾Œç«¯ signed cookieï¼‰
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>sessionStorage</span>.<span style=color:#a6e22e>setItem</span>(<span style=color:#e6db74>&#39;oauth_state&#39;</span>, <span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>nonce</span>) <span style=color:#a6e22e>sessionStorage</span>.<span style=color:#a6e22e>setItem</span>(<span style=color:#e6db74>&#39;oauth_nonce&#39;</span>, <span style=color:#a6e22e>nonce</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å¯é¡å¤–æŠŠ redirectAfterLogin åŠ å¯†å¾Œæ”¾å…¥ stateï¼ˆBase64 + HMACï¼‰
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>finalState</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>redirectAfterLogin</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>?</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span><span style=color:#e6db74>}</span><span style=color:#e6db74>|</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>btoa</span>(<span style=color:#a6e22e>redirectAfterLogin</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>:</span> <span style=color:#a6e22e>state</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URLSearchParams</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client_id</span>: <span style=color:#66d9ef>import.meta.env.VITE_CLIENT_ID</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>redirect_uri</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>origin</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/auth/callback`</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;code&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>provider</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;facebook&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;email&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;openid email profile&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>finalState</span>,
</span></span><span style=display:flex><span>    ...(<span style=color:#a6e22e>nonce</span> <span style=color:#f92672>&amp;&amp;</span> { <span style=color:#a6e22e>nonce</span> }),
</span></span><span style=display:flex><span>    <span style=color:#75715e>// PKCE æ¨è–¦åƒæ•¸
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>code_challenge</span>: <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>generateCodeChallenge</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>code_challenge_method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;S256&#39;</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>baseUrl</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>google</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;https://accounts.google.com/o/oauth2/v2/auth&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>facebook</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;https://www.facebook.com/v20.0/dialog/oauth&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apple</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;https://appleid.apple.com/auth/authorize&#39;</span>,
</span></span><span style=display:flex><span>  }[<span style=color:#a6e22e>provider</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>href</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>baseUrl</span><span style=color:#e6db74>}</span><span style=color:#e6db74>?</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>toString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å›èª¿é é¢é©—è­‰>å›èª¿é é¢é©—è­‰</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// pages/auth/callback.tsx
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>OAuthCallback() {</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>useEffect</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URLSearchParams</span>(window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>search</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>returnedState</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>params</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;state&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>params</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;code&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>error</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>params</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;error&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;OAuth éŒ¯èª¤:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>storedState</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sessionStorage</span>.<span style=color:#a6e22e>getItem</span>(<span style=color:#e6db74>&#39;oauth_state&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>returnedState</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>storedState</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>returnedState</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;|&#39;</span>)[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!==</span> <span style=color:#a6e22e>storedState</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Invalid state: å¯èƒ½é­å— CSRF æ”»æ“Šï¼&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// å¯å°å‘éŒ¯èª¤é é¢æˆ–ç™»å‡º
</span></span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¸…ç©ºå„²å­˜
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>sessionStorage</span>.<span style=color:#a6e22e>removeItem</span>(<span style=color:#e6db74>&#39;oauth_state&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sessionStorage</span>.<span style=color:#a6e22e>removeItem</span>(<span style=color:#e6db74>&#39;oauth_nonce&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘¼å«å¾Œç«¯ API äº¤æ› codeï¼ˆé¿å… client secret æ´©æ¼ï¼‰
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>exchangeCodeForTokens</span>(<span style=color:#a6e22e>code</span><span style=color:#f92672>!</span>, <span style=color:#a6e22e>provider</span>);
</span></span><span style=display:flex><span>  }, []);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>div</span>&gt;<span style=color:#960050;background-color:#1e0010>é©—è­‰ä¸­ï¼Œè«‹ç¨å€™</span>...&lt;/<span style=color:#f92672>div</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¾Œç«¯é©—è­‰ nonce ç¯„ä¾‹ï¼ˆNode.js / NestJS å½ç¢¼ï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>require</span>(<span style=color:#e6db74>&#39;jsonwebtoken&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>getPublicKey</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>require</span>(<span style=color:#e6db74>&#39;./apple-public-key&#39;</span>); <span style=color:#75715e>// æˆ– Google JWKS
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>verifyIdToken</span>(<span style=color:#a6e22e>idToken</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>storedNonce</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>idToken</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>nonce</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>storedNonce</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Nonce ä¸åŒ¹é…ï¼šé‡æ”¾æ”»æ“Šï¼&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ç¹¼çºŒé©—è­‰ç°½ç« ã€issuerã€audienceã€exp ç­‰
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=5-æœ€ä½³å¯¦è¸èˆ‡å¸¸è¦‹éŒ¯èª¤>5. æœ€ä½³å¯¦è¸èˆ‡å¸¸è¦‹éŒ¯èª¤</h2><ul><li>éš¨æ©Ÿå€¼ç”Ÿæˆï¼šæ°¸é ä½¿ç”¨ crypto.getRandomValues()ï¼Œé•·åº¦è‡³å°‘ 32 ä½å…ƒçµ„ï¼ˆ256-bit ç†µï¼‰ã€‚</li><li>å„²å­˜æ–¹å¼ï¼šSPA ç”¨ sessionStorageï¼›å‚³çµ±ç¶²é ç”¨ server-side session æˆ– HttpOnly + SameSite=Strict Cookieã€‚</li><li>é©—è­‰æ™‚æ©Ÿï¼šstate åœ¨å‰ç«¯ callback ç«‹å³æª¢æŸ¥ï¼›nonce åœ¨å¾Œç«¯ ID Token é©—è­‰æ™‚æª¢æŸ¥ã€‚</li><li>æ¸…é™¤æ©Ÿåˆ¶ï¼šé©—è­‰æˆåŠŸæˆ–å¤±æ•—å¾Œç«‹å³ç§»é™¤ã€‚</li><li>å¸¸è¦‹éŒ¯èª¤ï¼š<ul><li>ä½¿ç”¨ Math.random() ç”Ÿæˆ state/nonce</li><li>æŠŠ state å­˜åœ¨ localStorageï¼ˆè·¨ tab æŒä¹…åŒ–ï¼‰</li><li>åªåœ¨é–‹ç™¼ç’°å¢ƒé©—è­‰ï¼Œä¸Šç·šå¾Œç§»é™¤</li><li>æœªä½¿ç”¨ PKCEï¼ˆå° public client æ¥µå±éšªï¼‰</li></ul></li></ul><h2 id=çµè«–>çµè«–</h2><p>state å®ˆè­·æˆæ¬Šæµç¨‹çš„å®Œæ•´æ€§ï¼Œnonce å®ˆè­· ID Token çš„æ–°é®®åº¦ã€‚å…©è€…ç¼ºä¸€ä¸å¯ï¼Œæ˜¯æ•´åˆ Googleã€Facebookã€SIWA æ™‚æœ€é—œéµçš„è³‡å®‰é˜²ç·šã€‚</p><p>æ­£ç¢ºå¯¦ä½œé€™å…©å€‹åƒæ•¸ï¼Œèƒ½å¤§å¹…é™ä½ CSRFã€é‡æ”¾æ”»æ“Šé¢¨éšªï¼Œè®“ä½ çš„æ‡‰ç”¨ç¬¦åˆ OAuth 2.0 / OIDC è¦ç¯„èˆ‡å„å¤§æä¾›è€…çš„å®‰å…¨å¯©æ ¸è¦æ±‚ã€‚</p><p>å»ºè­°é–‹ç™¼åœ˜éšŠå°‡é€™äº›é‚è¼¯å°è£æˆå¯é‡ç”¨çš„ Hook / Middlewareï¼Œä¸¦æ­é…æˆç†Ÿ SDKï¼ˆå¦‚ <code>@auth0/auth0-spa-js</code>ã€<code>next-auth</code>ï¼‰åŠ é€Ÿé–‹ç™¼ã€‚</p><p>å¸Œæœ›æœ¬æ–‡èƒ½å¹«åŠ©ä½ åœ¨å¯¦å‹™å°ˆæ¡ˆä¸­å»ºç«‹æ›´å®‰å…¨çš„ç¬¬ä¸‰æ–¹ç™»å…¥ç³»çµ± ğŸ™‚</p></div></article><div id=share-buttons><div class=facebook title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=https://doggor.github.io//posts/2026/auth2-ocid-state-nonce-security/")'><svg viewBox="0 0 1792 1792"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759H734V905H479V609h255V391q0-186 104-288.5T1115 0q147 0 228 12z"/></svg></div><div class=twitter title="Share this on Twitter" onclick='window.open("https://twitter.com/intent/tweet?url=https://doggor.github.io//posts/2026/auth2-ocid-state-nonce-security/&text=OAuth2 æ•´åˆçš„å®‰å…¨æ ¸å¿ƒï¼šstate èˆ‡ nonce åƒæ•¸çš„æ­£ç¢ºä½¿ç”¨èˆ‡é©—è­‰")'><svg viewBox="0 0 1792 1792"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class=linkedin title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=https://doggor.github.io//posts/2026/auth2-ocid-state-nonce-security/&title=OAuth2 æ•´åˆçš„å®‰å…¨æ ¸å¿ƒï¼šstate èˆ‡ nonce åƒæ•¸çš„æ­£ç¢ºä½¿ç”¨èˆ‡é©—è­‰&summary=<p>åœ¨ç¾ä»£ç¶²é èˆ‡è¡Œå‹•æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæ•´åˆç¬¬ä¸‰æ–¹ç™»å…¥ï¼ˆå¦‚ Googleã€Facebookã€Sign In with Appleï¼Œç°¡ç¨± SIWAï¼‰å·²æ˜¯æ¨™æº–åŠŸèƒ½ã€‚é€™äº›åŠŸèƒ½åŸºæ–¼ <strong>OAuth 2.0</strong> å”è­°ï¼Œä¸¦å¸¸æ­é… <strong>OpenID Connect (OIDC)</strong> æ“´å±•ä¾†å–å¾—ä½¿ç”¨è€…èº«ä»½è³‡è¨Šã€‚ç„¶è€Œï¼Œé–‹ç™¼è€…åœ¨å¯¦ä½œæ™‚æœ€å¸¸å¿½ç•¥çš„è³‡å®‰é—œéµï¼Œæ­£æ˜¯ <strong>state</strong> èˆ‡ <strong>nonce</strong> å…©å€‹åƒæ•¸çš„æ­£ç¢ºç”Ÿæˆã€å‚³éèˆ‡é©—è­‰ã€‚</p>&source=https://doggor.github.io/")'><svg viewBox="0 0 1792 1792"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></div><div class=mail title="Share this through Email" onclick='window.open("mailto:?&&subject=OAuth2 æ•´åˆçš„å®‰å…¨æ ¸å¿ƒï¼šstate èˆ‡ nonce åƒæ•¸çš„æ­£ç¢ºä½¿ç”¨èˆ‡é©—è­‰&body=<p>åœ¨ç¾ä»£ç¶²é èˆ‡è¡Œå‹•æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæ•´åˆç¬¬ä¸‰æ–¹ç™»å…¥ï¼ˆå¦‚ Googleã€Facebookã€Sign In with Appleï¼Œç°¡ç¨± SIWAï¼‰å·²æ˜¯æ¨™æº–åŠŸèƒ½ã€‚é€™äº›åŠŸèƒ½åŸºæ–¼ <strong>OAuth 2.0</strong> å”è­°ï¼Œä¸¦å¸¸æ­é… <strong>OpenID Connect (OIDC)</strong> æ“´å±•ä¾†å–å¾—ä½¿ç”¨è€…èº«ä»½è³‡è¨Šã€‚ç„¶è€Œï¼Œé–‹ç™¼è€…åœ¨å¯¦ä½œæ™‚æœ€å¸¸å¿½ç•¥çš„è³‡å®‰é—œéµï¼Œæ­£æ˜¯ <strong>state</strong> èˆ‡ <strong>nonce</strong> å…©å€‹åƒæ•¸çš„æ­£ç¢ºç”Ÿæˆã€å‚³éèˆ‡é©—è­‰ã€‚</p>%0A%0Ahttps://doggor.github.io//posts/2026/auth2-ocid-state-nonce-security/")'><svg viewBox="0 0 1792 1792"><path d="M1792 710v794q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V710q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 1e2-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38T639 1015q-91-64-262-182.5T172 690q-62-42-117-115.5T0 438q0-78 41.5-130T160 256h1472q65 0 112.5 47t47.5 113z"/></svg></div></div><section class=disqus-area><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//doggor-coding-notebook.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section><script type=module async>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    const checkbox = document.getElementById("darkmode-switch-checkbox");
    document.querySelectorAll('pre.mermaid').forEach(el => {
        el.setAttribute('data-original-code', el.innerHTML);
    });
    const render = () => {
        document.querySelectorAll('pre.mermaid').forEach(el => {
            el.removeAttribute('data-processed');
            el.innerHTML = el.getAttribute('data-original-code');
        });
        mermaid.initialize({ theme: checkbox.checked ? 'dark' : 'default' });
        mermaid.run();
    };
    checkbox.addEventListener('change', render);
    render();
  </script></main></div></body></html>