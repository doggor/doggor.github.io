<!doctype html>
<html lang="zh-TW">

<head>
    <title>利用binlog修復MySQL // 碼農生活</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.54.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Doggor" />
    <meta name="description" content="最近因為一次手殘剷除了production主機上的MySQL數據庫，需要從最近時間點的備份中還原，並且從binlog中提取該時間點後的部分重要query重新執行，以盡可能回復原狀。" />
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="碼農生活">
    <link rel="apple-touch-icon" href="/images/icons/icon-152x152.png">
    <meta name="theme-color" content="#16191d" />
    
    
    <meta property="og:image" content="https://doggor.github.io//posts/repair-mysql-data-using-binlog/thumbnail.jpg">
    
    
    <meta property="og:tags" content="mysql">
    
    <meta property="og:tags" content="binlog">
    
    <meta property="og:tags" content="sql">
    
    <base href="https://doggor.github.io/" />
    <link rel="stylesheet" href="https://doggor.github.io/css/main.min.16abed0e30734b2607d642a17b5279ea.css" />
    <link rel="stylesheet" media="screen and (max-width: 939px)" href="https://doggor.github.io/css/mobile.min.be810d81064de9fff3dbf244d2814afb.css" />
    
    <script src="https://doggor.github.io/js/cookies-consent.min.3c6f7f73c9853ee1e5d637f02f1abaf6.js" defer></script>
    
    <script src="https://doggor.github.io/js/topbar-actions.min.9e50b64f91b4beeaa3d1458c8b469ab2.js" defer></script>
    
    
    
    <script src="https://doggor.github.io/js/service-worker-loader.min.js" defer></script>
    
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="preconnect" href="https://www.google-analytics.com">
    
    <script src="https://doggor.github.io/js/gtag.min.js" defer></script>
    
    
    <script src="https://doggor.github.io/js/sidebar.min.js" defer></script>
</head>

<body>
    <header class="app-header">
        <h3 class="app-header-wanna-say">&nbsp;</h3>
        <h1 class="app-header-my-face">_(:з」∠)_</h1>
        <a href="/" aria-label="Home"><h2>#碼農生活</h2></a>

        
        <div class="app-header-tag-group">
        
        
        <a class="tag-btn" href="/tags/binlog/" aria-label="tag:binlog">
            <span>binlog</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/canvas/" aria-label="tag:canvas">
            <span>canvas</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/centos/" aria-label="tag:centos">
            <span>centos</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/ci/" aria-label="tag:ci">
            <span>ci</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/crawler/" aria-label="tag:crawler">
            <span>crawler</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/debug/" aria-label="tag:debug">
            <span>debug</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/docker/" aria-label="tag:docker">
            <span>docker</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/fail2ban/" aria-label="tag:fail2ban">
            <span>fail2ban</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/firewall/" aria-label="tag:firewall">
            <span>firewall</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/ftp/" aria-label="tag:ftp">
            <span>ftp</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/git/" aria-label="tag:git">
            <span>git</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/gitlab/" aria-label="tag:gitlab">
            <span>gitlab</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/gzip/" aria-label="tag:gzip">
            <span>gzip</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/headless-chrome/" aria-label="tag:headless-chrome">
            <span>headless-chrome</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/html/" aria-label="tag:html">
            <span>html</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/indexing/" aria-label="tag:indexing">
            <span>indexing</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/influx/" aria-label="tag:influx">
            <span>influx</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/js/" aria-label="tag:js">
            <span>js</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/malicious/" aria-label="tag:malicious">
            <span>malicious</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/mysql/" aria-label="tag:mysql">
            <span>mysql</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/nginx/" aria-label="tag:nginx">
            <span>nginx</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/nodejs/" aria-label="tag:nodejs">
            <span>nodejs</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/ntp/" aria-label="tag:ntp">
            <span>ntp</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/php/" aria-label="tag:php">
            <span>php</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/puppeteer/" aria-label="tag:puppeteer">
            <span>puppeteer</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/react/" aria-label="tag:react">
            <span>react</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/sql/" aria-label="tag:sql">
            <span>sql</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/tfjs/" aria-label="tag:tfjs">
            <span>tfjs</span>
        </a>
        
        
        <a class="tag-btn" href="/tags/vscode/" aria-label="tag:vscode">
            <span>vscode</span>
        </a>
        
        </div>
        

        <div class="app-header-links">
            <a class="tag-link" href="/categories" aria-label="Categories"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-folder">
  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
</svg></a>
            <a class="tag-link" href="/tags" aria-label="Tags"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg></a>
            
            <a target="_blank" href="https://github.com/doggor" rel="noopener" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
            
        </div>
    </header>

    <div class="app-topbar">
        <div class="app-topbar-menu-btn" aria-label="menu">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <a href="/" aria-label="Home">
            <h3>#碼農生活</h3>
        </a>
    </div>

    <main class="app-container">
        
  <article class="post">
    <header class="post-header">
      <div>
        <h1 class ="post-title">利用binlog修復MySQL</h1>
        


<div id="share-buttons">
<div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https:\/\/doggor.github.io\/\/posts\/repair-mysql-data-using-binlog\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
<div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=https:\/\/doggor.github.io\/\/posts\/repair-mysql-data-using-binlog\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
<div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https:\/\/doggor.github.io\/\/posts\/repair-mysql-data-using-binlog\/&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>

<div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=https:\/\/doggor.github.io\/\/posts\/repair-mysql-data-using-binlog\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>

      </div>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Oct 1, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://doggor.github.io/tags/mysql/">mysql</a><a class="tag" href="https://doggor.github.io/tags/binlog/">binlog</a><a class="tag" href="https://doggor.github.io/tags/sql/">sql</a></div></div>
    </header>
    <div class="post-content">
      <p>最近因為一次手殘剷除了production主機上的MySQL數據庫，需要從最近時間點的備份中還原，並且從binlog中提取該時間點後的部分重要query重新執行，以盡可能回復原狀。</p>

<p>若想了解binlog的構造，美團有一篇不錯的技術文︰<a href="https://tech.meituan.com/2017/11/17/mysql-flashback.html">https://tech.meituan.com/2017/11/17/mysql-flashback.html</a></p>

<h3 id="相關文件路徑-centos-7-mysql-5-7">相關文件路徑﹙CentOS 7，MySQL 5.7﹚︰</h3>

<ul>
<li>MySQL設定檔︰/etc/my.cnf</li>
<li>binlog文件路徑︰/var/lib/mysql﹙以設定檔內記載為準﹚</li>
</ul>

<h3 id="前設條件">前設條件</h3>

<ol>
<li>MySQL本身有啟用<a href="https://dev.mysql.com/doc/refman/5.7/en/replication-howto-masterbaseconfig.html">binlog</a>，否則只能從備份還原；</li>
<li>手上持有最近的備份﹙假設是用<code>mysqldump</code>做備份﹚，並知道該備份的創建時間；</li>
<li>binlog文件會因為過期或超出數量限制而被自動銷毀，所以要先確認現時最舊的binlog的創建時間，必須先於你手上的備份的創建時間，以確保沒有真空期。</li>
</ol>

<h3 id="準備操作">準備操作</h3>

<ol>
<li>先從最近時間點的備份中還原。</li>
<li>找出最接近該備份時間的binlog。
例如︰備份的創建時間是 2019-10-01 09:30，則找出一個binlog其創建時間最接近而又不大於2019-10-01 09:30。
由這個binlog開始，以及往後的所有binlog都是即將要進行操作的對象。</li>
<li><code>mysqlbinlog</code>指令通常已跟隨MySQL一並安裝到主機，而<code>awk</code>若不可用請透過包管理器安裝。</li>
</ol>

<h3 id="提取binlog中的query">提取binlog中的query</h3>

<p>假設第一個要進行操作的binlog名為<code>mysql-bin.0011</code>，可使用<code>mysqlbinlog</code>轉化成純文字sql檔︰</p>

<pre><code class="language-sh">mysqlbinlog -v mysql-bin.0011 &gt; mysql-0011.sql
</code></pre>

<p>如果你打算重新執行所有query，在備份中找出MASTER_LOG_POS，由這個位置開始讀取︰</p>

<pre><code class="language-sh">mysqlbinlog -j &lt;MASTER_LOG_POS&gt; -v mysql-bin.0011 &gt; mysql-0011.sql
</code></pre>

<p>若我們只想提取對<code>table_1</code>table有影響的 query，可使用<code>awk</code>作過濾︰</p>

<pre><code class="language-sh">mysqlbinlog -v mysql-bin.0011 | awk '/table_1/,/;/' &gt; mysql-0011.buy.sql
</code></pre>

<blockquote>
<p>由於<code>mysqlbinlog</code>輸出的每條query都佔據多行，需要支援跨行模式識別的<code>awk</code>而非<code>grep</code>。</p>
</blockquote>

<p>較普遍的情況是我們需要處理大量binlog文件，可使用<code>*</code>號省略文件範圍︰</p>

<pre><code class="language-sh"># mysql-bin.0010 ~ mysql-bin.0019
mysqlbinlog -v mysql-bin.001* | awk '/table_1/,/;/' &gt; mysql-0089.buy.sql
</code></pre>

<p>即使table的主鍵是使用AUTO_INCREMENT，輸出的INSERT語句的主鍵值都是確定的，這可避免修復時的一些誤操作。</p>

<blockquote>
<p>這裡可找到更多使用<code>mysqlbinlog</code>的方法：<a href="http://www.ttlsa.com/mysql/super-useful-mysqlbinlog-command/">http://www.ttlsa.com/mysql/super-useful-mysqlbinlog-command/</a></p>
</blockquote>

<h3 id="大型-sql-文件檢視及編輯">大型.sql 文件檢視及編輯</h3>

<p>有時候你可能需要對備份或由<code>mysqlbinlog</code>輸出的大型.sql文件進行人工檢視或修改，若資訊量太大，可試用以下工具開啟檔案︰</p>

<ol>
<li><a href="https://www.emeditor.com/">EmEditor</a>, up to 248 GB or 2.1 billion lines (30 日免費試用)</li>
<li><a href="https://www.liquid-technologies.com/large-file-editor">Large File Editor (liquid studio)</a>, In principle its over 9000 petabytes</li>
</ol>

<h3 id="重新執行-query-之前">重新執行 query 之前</h3>

<p>建議你在執行上面提取出的.sql文件之前打開看一看內容，確保︰</p>

<ol>
<li>每條query是格式正確的﹙<code>awk</code>有機會因為匹配錯誤而輸出非預期的結果﹚；</li>
<li>首條query是在備份時間點後出現﹙視乎提取方法你可能需要移除部分 query﹚；</li>
<li>各 table 的首條 INSERT query 的主鍵沒有重複出現在備份上﹙duplicate entry﹚；</li>
<li>對於有時間截欄位的table, 例如包含<code>created_at</code>、<code>updated_at</code>欄位的table，從它的INSERT query, UPDATE query中出現的時間值去再次確保該段query未曾執行在備份數據上。</li>
</ol>

<h3 id="暫停索引和外鍵檢查">暫停索引和外鍵檢查</h3>

<p>如果query數量很多，可參考<a href="/posts/stop-mysql-indexing-and-reference-checking">下一篇</a>暫停索引和外鍵檢查。</p>

<h3 id="執行query">執行query</h3>

<p>調整好.sql文件後，你可以使用<code>mysql</code>執行這些query︰</p>

<pre><code class="language-sh">mysql -u root -p &lt; mysql-0011.buy.sql
</code></pre>

<blockquote>
<p>如果你暫停了索引和外鍵檢查，別忘記執行完成後要重啟這兩項喔～</p>
</blockquote>

<h3 id="防呆措施">防呆措施</h3>

<p>若遇上類似情況，人手操作是不可避免的。故此須要從習慣改變︰</p>

<ol>
<li>對所有數據庫檔案操作，盡可能避免使用<code>rm</code>指令</li>
<li>以<a href="https://github.com/andreafrancia/trash-cli"><code>trash-cli</code></a>取代<code>rm</code></li>
<li>當數據庫主機容量不足時(或預計使用<code>trash-cli</code>所需的空間不足時)，先增加其儲存容量</li>
<li>重建數據庫前除了考慮數據本身佔用之容量，同時亦需要考慮其建構indexes時臨時佔用之容量﹙一般不大於數據本身﹚</li>
<li>執行需時較長的query時，可考慮使用<a href="https://mosh.org/">mosh</a>、<a href="https://github.com/tmux/tmux">tmux</a>以保持當前SSH session，避免因網絡問題或宕機等意外而導致執行失敗</li>
</ol>
    </div>
  </article>
  <section class="disqus-area"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "doggor-coding-notebook" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section>

    </main>
</body>

</html>
